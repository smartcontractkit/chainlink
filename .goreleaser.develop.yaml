version: 2
project_name: chainlink
env:
    - IMAGE_PREFIX={{ if index .Env "IMAGE_PREFIX"  }}{{ .Env.IMAGE_PREFIX }}{{ else }}localhost:5001{{ end }}
    - IMAGE_TAG={{ if index .Env "IMAGE_TAG" }}{{ .Env.IMAGE_TAG }}{{ else }}develop{{ end }}
    - VERSION={{ if index .Env "CHAINLINK_VERSION" }}{{ .Env.CHAINLINK_VERSION }}{{ else }}v0.0.0-local{{ end }}
    - IMAGE_LABEL_DESCRIPTION="node of the decentralized oracle network, bridging on and off-chain computation"
    - IMAGE_LABEL_LICENSES="MIT"
    - IMAGE_LABEL_SOURCE="https://github.com/smartcontractkit/{{ .ProjectName }}"
release:
    disable: "true"
builds:
    - targets:
        - go_first_class
      binary: chainlink
      hooks:
        post:
            - cmd: ./tools/bin/goreleaser_utils build_post_hook {{ dir .Path }}
      no_unique_dist_dir: "true"
      ldflags:
        - -s -w -r=$ORIGIN/libs
        - -X github.com/smartcontractkit/chainlink/v2/core/static.Version={{ .Env.VERSION }}
        - -X github.com/smartcontractkit/chainlink/v2/core/static.Sha={{ .FullCommit }}
      flags:
        - -trimpath
        - -buildmode=pie
archives:
    - format: binary
snapshot:
    version_template: '{{ .Env.VERSION }}-{{ .ShortCommit }}'
checksum:
    name_template: checksums.txt
dockers:
    - id: linux-amd64-chainlink
      goos: linux
      goarch: amd64
      dockerfile: core/chainlink.goreleaser.Dockerfile
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-amd64'
      extra_files:
        - tmp/libs
      build_flag_templates:
        - --platform=linux/amd64
        - --pull
        - --build-arg=CHAINLINK_USER=chainlink
        - --build-arg=COMMIT_SHA={{ .FullCommit }}
        - --label=org.opencontainers.image.created={{ .Date }}
        - --label=org.opencontainers.image.description={{ .Env.IMAGE_LABEL_DESCRIPTION }}
        - --label=org.opencontainers.image.licenses={{ .Env.IMAGE_LABEL_LICENSES }}
        - --label=org.opencontainers.image.revision={{ .FullCommit }}
        - --label=org.opencontainers.image.source={{ .Env.IMAGE_LABEL_SOURCE }}
        - --label=org.opencontainers.image.title={{ .ProjectName }}
        - --label=org.opencontainers.image.version={{ .Env.VERSION }}
        - --label=org.opencontainers.image.url={{ .Env.IMAGE_LABEL_SOURCE }}
      use: buildx
    - id: linux-amd64-chainlink-plugins
      goos: linux
      goarch: amd64
      dockerfile: core/chainlink.goreleaser.Dockerfile
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-plugins'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-plugins-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-plugins-amd64'
      extra_files:
        - tmp/libs
        - tmp/plugins
      build_flag_templates:
        - --platform=linux/amd64
        - --pull
        - --build-arg=CHAINLINK_USER=chainlink
        - --build-arg=COMMIT_SHA={{ .FullCommit }}
        - --build-arg=CL_MEDIAN_CMD=chainlink-feeds
        - --build-arg=CL_MERCURY_CMD=chainlink-mercury
        - --build-arg=CL_SOLANA_CMD=chainlink-solana
        - --build-arg=CL_STARKNET_CMD=chainlink-starknet
        - --label=org.opencontainers.image.created={{ .Date }}
        - --label=org.opencontainers.image.description={{ .Env.IMAGE_LABEL_DESCRIPTION }}
        - --label=org.opencontainers.image.licenses={{ .Env.IMAGE_LABEL_LICENSES }}
        - --label=org.opencontainers.image.revision={{ .FullCommit }}
        - --label=org.opencontainers.image.source={{ .Env.IMAGE_LABEL_SOURCE }}
        - --label=org.opencontainers.image.title={{ .ProjectName }}
        - --label=org.opencontainers.image.version={{ .Env.VERSION }}
        - --label=org.opencontainers.image.url={{ .Env.IMAGE_LABEL_SOURCE }}
      use: buildx
    - id: linux-arm64-chainlink
      goos: linux
      goarch: arm64
      dockerfile: core/chainlink.goreleaser.Dockerfile
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-arm64'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-arm64'
      extra_files:
        - tmp/libs
      build_flag_templates:
        - --platform=linux/arm64
        - --pull
        - --build-arg=CHAINLINK_USER=chainlink
        - --build-arg=COMMIT_SHA={{ .FullCommit }}
        - --label=org.opencontainers.image.created={{ .Date }}
        - --label=org.opencontainers.image.description={{ .Env.IMAGE_LABEL_DESCRIPTION }}
        - --label=org.opencontainers.image.licenses={{ .Env.IMAGE_LABEL_LICENSES }}
        - --label=org.opencontainers.image.revision={{ .FullCommit }}
        - --label=org.opencontainers.image.source={{ .Env.IMAGE_LABEL_SOURCE }}
        - --label=org.opencontainers.image.title={{ .ProjectName }}
        - --label=org.opencontainers.image.version={{ .Env.VERSION }}
        - --label=org.opencontainers.image.url={{ .Env.IMAGE_LABEL_SOURCE }}
      use: buildx
    - id: linux-arm64-chainlink-plugins
      goos: linux
      goarch: arm64
      dockerfile: core/chainlink.goreleaser.Dockerfile
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-plugins-arm64'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-plugins-arm64'
      extra_files:
        - tmp/libs
        - tmp/plugins
      build_flag_templates:
        - --platform=linux/arm64
        - --pull
        - --build-arg=CHAINLINK_USER=chainlink
        - --build-arg=COMMIT_SHA={{ .FullCommit }}
        - --build-arg=CL_MEDIAN_CMD=chainlink-feeds
        - --build-arg=CL_MERCURY_CMD=chainlink-mercury
        - --build-arg=CL_SOLANA_CMD=chainlink-solana
        - --build-arg=CL_STARKNET_CMD=chainlink-starknet
        - --label=org.opencontainers.image.created={{ .Date }}
        - --label=org.opencontainers.image.description={{ .Env.IMAGE_LABEL_DESCRIPTION }}
        - --label=org.opencontainers.image.licenses={{ .Env.IMAGE_LABEL_LICENSES }}
        - --label=org.opencontainers.image.revision={{ .FullCommit }}
        - --label=org.opencontainers.image.source={{ .Env.IMAGE_LABEL_SOURCE }}
        - --label=org.opencontainers.image.title={{ .ProjectName }}
        - --label=org.opencontainers.image.version={{ .Env.VERSION }}
        - --label=org.opencontainers.image.url={{ .Env.IMAGE_LABEL_SOURCE }}
      use: buildx
    - id: linux-amd64-ccip
      goos: linux
      goarch: amd64
      dockerfile: core/chainlink.goreleaser.Dockerfile
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-amd64'
      extra_files:
        - tmp/libs
        - ccip/config
      build_flag_templates:
        - --platform=linux/amd64
        - --pull
        - --build-arg=CHAINLINK_USER=chainlink
        - --build-arg=COMMIT_SHA={{ .FullCommit }}
        - --build-arg=CL_CHAIN_DEFAULTS=/chainlink/ccip-config
        - --label=org.opencontainers.image.created={{ .Date }}
        - --label=org.opencontainers.image.description={{ .Env.IMAGE_LABEL_DESCRIPTION }}
        - --label=org.opencontainers.image.licenses={{ .Env.IMAGE_LABEL_LICENSES }}
        - --label=org.opencontainers.image.revision={{ .FullCommit }}
        - --label=org.opencontainers.image.source={{ .Env.IMAGE_LABEL_SOURCE }}
        - --label=org.opencontainers.image.title={{ .ProjectName }}
        - --label=org.opencontainers.image.version={{ .Env.VERSION }}
        - --label=org.opencontainers.image.url={{ .Env.IMAGE_LABEL_SOURCE }}
      use: buildx
    - id: linux-amd64-ccip-plugins
      goos: linux
      goarch: amd64
      dockerfile: core/chainlink.goreleaser.Dockerfile
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-plugins'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-plugins-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-plugins-amd64'
      extra_files:
        - tmp/libs
        - tmp/plugins
        - ccip/config
      build_flag_templates:
        - --platform=linux/amd64
        - --pull
        - --build-arg=CHAINLINK_USER=chainlink
        - --build-arg=COMMIT_SHA={{ .FullCommit }}
        - --build-arg=CL_CHAIN_DEFAULTS=/chainlink/ccip-config
        - --build-arg=CL_MEDIAN_CMD=chainlink-feeds
        - --build-arg=CL_MERCURY_CMD=chainlink-mercury
        - --build-arg=CL_SOLANA_CMD=chainlink-solana
        - --build-arg=CL_STARKNET_CMD=chainlink-starknet
        - --label=org.opencontainers.image.created={{ .Date }}
        - --label=org.opencontainers.image.description={{ .Env.IMAGE_LABEL_DESCRIPTION }}
        - --label=org.opencontainers.image.licenses={{ .Env.IMAGE_LABEL_LICENSES }}
        - --label=org.opencontainers.image.revision={{ .FullCommit }}
        - --label=org.opencontainers.image.source={{ .Env.IMAGE_LABEL_SOURCE }}
        - --label=org.opencontainers.image.title={{ .ProjectName }}
        - --label=org.opencontainers.image.version={{ .Env.VERSION }}
        - --label=org.opencontainers.image.url={{ .Env.IMAGE_LABEL_SOURCE }}
      use: buildx
    - id: linux-arm64-ccip
      goos: linux
      goarch: arm64
      dockerfile: core/chainlink.goreleaser.Dockerfile
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-arm64'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-arm64'
      extra_files:
        - tmp/libs
        - ccip/config
      build_flag_templates:
        - --platform=linux/arm64
        - --pull
        - --build-arg=CHAINLINK_USER=chainlink
        - --build-arg=COMMIT_SHA={{ .FullCommit }}
        - --build-arg=CL_CHAIN_DEFAULTS=/chainlink/ccip-config
        - --label=org.opencontainers.image.created={{ .Date }}
        - --label=org.opencontainers.image.description={{ .Env.IMAGE_LABEL_DESCRIPTION }}
        - --label=org.opencontainers.image.licenses={{ .Env.IMAGE_LABEL_LICENSES }}
        - --label=org.opencontainers.image.revision={{ .FullCommit }}
        - --label=org.opencontainers.image.source={{ .Env.IMAGE_LABEL_SOURCE }}
        - --label=org.opencontainers.image.title={{ .ProjectName }}
        - --label=org.opencontainers.image.version={{ .Env.VERSION }}
        - --label=org.opencontainers.image.url={{ .Env.IMAGE_LABEL_SOURCE }}
      use: buildx
    - id: linux-arm64-ccip-plugins
      goos: linux
      goarch: arm64
      dockerfile: core/chainlink.goreleaser.Dockerfile
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-plugins-arm64'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-plugins-arm64'
      extra_files:
        - tmp/libs
        - tmp/plugins
        - ccip/config
      build_flag_templates:
        - --platform=linux/arm64
        - --pull
        - --build-arg=CHAINLINK_USER=chainlink
        - --build-arg=COMMIT_SHA={{ .FullCommit }}
        - --build-arg=CL_CHAIN_DEFAULTS=/chainlink/ccip-config
        - --build-arg=CL_MEDIAN_CMD=chainlink-feeds
        - --build-arg=CL_MERCURY_CMD=chainlink-mercury
        - --build-arg=CL_SOLANA_CMD=chainlink-solana
        - --build-arg=CL_STARKNET_CMD=chainlink-starknet
        - --label=org.opencontainers.image.created={{ .Date }}
        - --label=org.opencontainers.image.description={{ .Env.IMAGE_LABEL_DESCRIPTION }}
        - --label=org.opencontainers.image.licenses={{ .Env.IMAGE_LABEL_LICENSES }}
        - --label=org.opencontainers.image.revision={{ .FullCommit }}
        - --label=org.opencontainers.image.source={{ .Env.IMAGE_LABEL_SOURCE }}
        - --label=org.opencontainers.image.title={{ .ProjectName }}
        - --label=org.opencontainers.image.version={{ .Env.VERSION }}
        - --label=org.opencontainers.image.url={{ .Env.IMAGE_LABEL_SOURCE }}
      use: buildx
docker_manifests:
    - id: tagged-chainlink
      name_template: '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}'
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-arm64'
    - id: sha-chainlink
      name_template: '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}'
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-arm64'
    - id: tagged-plugins-chainlink
      name_template: '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-plugins'
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-plugins'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-plugins-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:{{ .Env.IMAGE_TAG }}-plugins-arm64'
    - id: sha-plugins-chainlink
      name_template: '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-plugins'
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-plugins-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/chainlink:sha-{{ .ShortCommit }}-plugins-arm64'
    - id: tagged-ccip
      name_template: '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}'
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-arm64'
    - id: sha-ccip
      name_template: '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}'
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-arm64'
    - id: tagged-plugins-ccip
      name_template: '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-plugins'
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-plugins'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-plugins-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:{{ .Env.IMAGE_TAG }}-plugins-arm64'
    - id: sha-plugins-ccip
      name_template: '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-plugins'
      image_templates:
        - '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-plugins-amd64'
        - '{{ .Env.IMAGE_PREFIX }}/ccip:sha-{{ .ShortCommit }}-plugins-arm64'
changelog:
    disable: "true"
docker_signs:
    - args:
        - sign
        - ${artifact}
        - --yes
      artifacts: all
before:
    hooks:
        - cmd: go mod tidy
        - cmd: ./tools/bin/goreleaser_utils before_hook
partial:
    by: target
nightly:
    version_template: '{{ .Env.VERSION }}-{{ .Env.IMAGE_TAG }}'
