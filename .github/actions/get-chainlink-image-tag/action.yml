name: Get Chainlink Image Tag
description: Gets the image tag and release type for the Chainlink image

inputs:
  publish:
    description: Whether to publish the image
    required: false
    default: false

outputs:
  image-tag:
    description: The tag that will be used to build and push the Chainlink image
    value: ${{ steps.get-image-tag.outputs.image-tag }}
  release-type:
    description: The type of release that will be used to build and push the Chainlink image
    value: ${{ steps.get-image-tag.outputs.release-type }}

runs:
  using: composite
  steps:
      - name: Get image tag
        shell: bash
        id: get-image-tag
        run: |
          short_sha=$(git rev-parse --short HEAD)
          echo "release-type=snapshot" | tee -a $GITHUB_OUTPUT
          if [[ ${{ github.event_name }} == 'push' ]]; then
            echo "image-tag=develop" | tee -a $GITHUB_OUTPUT
            echo "release-type=nightly" | tee -a $GITHUB_OUTPUT
          elif [[ ${{ github.event_name }} == 'workflow_dispatch' ]]; then
            echo "image-tag=${short_sha}" | tee -a $GITHUB_OUTPUT
              if [[ "${{ inputs.publish }}" == 'false' ]]; then
                echo "release-type=snapshot" | tee -a $GITHUB_OUTPUT
              else
                echo "release-type=nightly" | tee -a $GITHUB_OUTPUT
            fi
          else
            if [[ ${{ github.event_name }} == "pull_request" ]]; then
              echo "image-tag=pr-${{ github.event.number }}-${short_sha}" | tee -a $GITHUB_OUTPUT
              echo "release-type=nightly" | tee -a $GITHUB_OUTPUT
            fi
          fi
