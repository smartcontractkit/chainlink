name: Solidity-Hardhat
on:
  push:
  workflow_dispatch:
    inputs:
      product:
        type: choice
        description: 'product for which to generate artifacts; should be the same as Foundry profile'
        required: true
        options:
          - "automation"
          - "ccip"
          - "functions"
          - "keystone"
          - "l2ep"
          - "liquiditymanager"
          - "llo-feeds"
          - "operatorforwarder"
          - "transmission"
          - "vrf"
      base_ref:
        description: 'commit or tag to be used as base reference, when looking for modified Solidity files'
        required: true

env:
  FOUNDRY_PROFILE: ci
  # Has to match the `make foundry` version.
  FOUNDRY_VERSION: nightly-de33b6af53005037b463318d2628b5cfcaf39916
  PRODUCT: "functions"
  BASE_REF: "v2.13.0"

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      changes: ${{ steps.changes.outputs.sol }}
      product_changes: ${{ steps.changes.outputs.product }}
      shared_changes: ${{ steps.changes.outputs.shared }}
      files: ${{ steps.changes.outputs.included_files }}
      changeset_changes: ${{ steps.changes-dorny.outputs.changeset }}
      changeset_files: ${{ steps.changes-dorny.outputs.changeset_files }}
    steps:
      - name: Checkout the repo
        uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2
      - name: Find modified contracts
        uses: AurorNZ/paths-filter@3b1f3abc3371cca888d8eb03dfa70bc8a9867629 # v4.0.0
        id: changes
        with:
          list-files: 'csv'
          base: ${{ env.BASE_REF }} #TODO change to inputs.base_ref after testing
          filters: |
            ignored: &ignored
              - '!contracts/src/v0.8/**/test/**'
              - '!contracts/src/v0.8/**/tests/**'
              - '!contracts/src/v0.8/**/*.t.sol'
              - '!contracts/src/v0.8/*.t.sol'
              - '!contracts/src/v0.8/**/testhelpers/**'
              - '!contracts/src/v0.8/testhelpers/**'
              - '!contracts/src/v0.8/vendor/**'
            shared: &shared
              - 'contracts/src/v0.8/shared/**/*.sol'
              - 'contracts/src/v0.8/interfaces/**/*.sol'
              - 'contracts/src/v0.8/*.sol'
              - *ignored     
            sol:
              - 'contracts/src/v0.8/**/*.sol'
              - *ignored   
            product: &product
              - 'contracts/src/v0.8/${{ env.PRODUCT }}/**/*.sol'         
              - *ignored            
            included:
              - *product
              - *shared
              - *ignored

      - name: Find modified changesets
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes-dorny
        with:
          list-files: 'shell'
          base: ${{ env.BASE_REF }} #TODO change to inputs.base_ref after testing
          filters: |
            changeset:
              - modified|added: 'contracts/.changeset/!(README)*.md'

      - name: Check for changes outside of artifact scope
        if: ${{ steps.changes.outputs.sol == 'true' }}
        shell: bash
        run: |
          echo "::debug::All modified contracts:"
          echo ${{ steps.changes.outputs.all_sol_files }} | tr ',' '\n'          
          echo "::debug::Filtered modified contracts:"
          echo ${{ steps.changes.outputs.sol_files }} | tr ',' '\n'
          excluded_paths_pattern="!/^contracts\/src\/v0\.8\/shared/ && !/^contracts\/src\/v0\.8\/${{ env.PRODUCT}}/ && !/^contracts\/src\/v0\.8\/[^\/]+\.sol$/"
          echo "::debug::Excluded paths: $excluded_paths_pattern"
          unexpected_files=$(echo ${{ steps.changes.outputs.sol_files }} | tr ',' '\n' | awk "$excluded_paths_pattern")
          set -e 
          set -o pipefail
          if [[ -n "$unexpected_files" ]]; then
            products=()
            productsStr=""
            IFS=$'\n' read -r -d '' -a files <<< "$unexpected_files" || true
            echo "Files: ${files[@]}"
          
            for file in "${files[@]}"; do
              product=$(echo "$file" | awk -F'src/[^/]*/' '{print $2}' | cut -d'/' -f1)
              if [[ ! " ${products[@]} " =~ " ${product} " ]]; then
                products+=("$product")
                productsStr+="$product, "
              fi
            done
            productsStr=${productsStr%, }
          
            set +e 
            set +o pipefail
          
            echo "Error: Found modified contracts outside of the expected scope: ${{ env.PRODUCT }}, shared"
            echo "Files:"
            echo "$unexpected_files"
            echo "Action required: If you want to generate artifacts for other products ($productsStr) run this workflow again with updated configuration"
          
            echo "# Warning!" >> $GITHUB_STEP_SUMMARY
            echo "## Reason: Found modified contracts outside of the expected scope: ${{ env.PRODUCT }}, shared" >> $GITHUB_STEP_SUMMARY
            echo "### Files:" >> $GITHUB_STEP_SUMMARY
            echo "$unexpected_files" >> $GITHUB_STEP_SUMMARY
            echo "## Action required: If you want to generate artifacts for other products ($productsStr) run this workflow again with updated configuration" >> $GITHUB_STEP_SUMMARY            
          else
            echo "No unexpected files found."
          fi

      - name: Check for changes only in shared
        if: ${{ steps.changes.outputs.product == 'false' && steps.changes.outputs.shared == 'true' }}
        shell: bash
        run: |
          echo "# Warning!" >> $GITHUB_STEP_SUMMARY
          echo "## Reason: Found No modified contracts for product ${{ env.PRODUCT }}" >> $GITHUB_STEP_SUMMARY
          echo "## Action required: Please check if you chose correct product and base reference" >> $GITHUB_STEP_SUMMARY
          echo "## Product: ${{ env.PRODUCT }}" >> $GITHUB_STEP_SUMMARY
          #TODO change to inputs.base_ref after testing
          echo "## Base Ref: ${{ env.BASE_REF }}" >> $GITHUB_STEP_SUMMARY

  gather-basic-info:
    if: ${{ needs.changes.outputs.changeset_changes == 'true' }}
    name: Gather basic info
    runs-on: ubuntu-22.04
    needs: [ changes ]
    steps:
      - name: Checkout the repo
        uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Copy modified changesets
        run: |
          mkdir -p contracts/changesets/changesets
          for changeset in "${{ needs.changes.outputs.changeset_files }}"; do
            echo "::debug:: Copying $changeset"
            cp $changeset contracts/changesets/changesets
          done

      - name: Generate basic info
        shell: bash
        run: |
          echo "Commit SHA used to generate artifacts: ${{ github.sha }}" > contracts/commit_sha_base_ref.txt
          #TODO change to inputs.base_ref after testing
          echo "Base reference SHA used to find modified contracts: ${{ env.BASE_REF }}" >> contracts/commit_sha_base_ref.txt 
          contract_list="${{ needs.changes.outputs.files }}"
          new_line_list=$(echo "$contract_list" | tr ',' '\n' | sed 's/,$//')
          printf "%s\n" "$new_line_list" > contracts/modified_contracts.txt
          
          cat contracts/modified_contracts.txt          

      - name: Generate modified contracts list
        shell: bash
        run: |
          IFS=',' read -r -a modified_files <<< "${{ needs.changes.outputs.files }}"
          echo "# Modified contracts:" > contracts/modified_contracts.md
          for file in "${modified_files[@]}"; do          
            # TODO remove this check when AurorNZ/paths-filter is fixed
            status=$(git diff --name-status ${{ env.BASE_REF }} ${{ github.sha }} -- "$file"  | awk '{ print $1 }')
            if [ "$status" == "D" ]; then
              echo "File $file was deleted, skipping."
              continue
            fi
          
            echo " - [$file](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/$file)" >> contracts/modified_contracts.md
          done

      - name: Upload basic info
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b # v4.3.4
        timeout-minutes: 2
        continue-on-error: true
        with:
          name: tmp-basic-info
          path: |
            contracts/modified_contracts.md
            contracts/modified_contracts.txt
            contracts/commit_sha_base_ref.txt            
            contracts/changesets
          retention-days: 7

  # some of the artifacts can only be generated on product level, and we cannot scope them to single contracts
  # some product-level modifications might also require shared contracts changes, so if these happened we need to generate artifacts for shared contracts as well
  coverage-and-book:
    if: ${{ needs.changes.outputs.product_changes == 'true' || needs.changes.outputs.shared_changes == 'true' }}
    name: Generate Docs and Code Coverage reports
    runs-on: ubuntu-22.04
    needs: [changes]
    steps:
      - name: Checkout the repo
        uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2
        with:
          submodules: recursive

      - name: Setup NodeJS
        uses: ./.github/actions/setup-nodejs

      - name: Create directories
        shell: bash
        run: |
          mkdir -p contracts/code-coverage  

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8f1998e9878d786675189ef566a2e4bf24869773 # v1.2.0
        with:
          version: ${{ env.FOUNDRY_VERSION }}

      # required for code coverage report generation
      - name: Setup LCOV
        uses: hrishikesh-kadam/setup-lcov@f5da1b26b0dcf5d893077a3c4f29cf78079c841d # v1.0.0

      - name: Run Forge build for product contracts
        if: ${{ needs.changes.outputs.product_changes == 'true' }}
        run: |
          forge --version
          forge build
        working-directory: contracts
        env:
          FOUNDRY_PROFILE: ${{ env.PRODUCT }}

      - name: Run Forge build for shared contracts
        if: ${{ needs.changes.outputs.shared_changes == 'true' }}
        run: |
          forge --version
          forge build
        working-directory: contracts
        env:
          FOUNDRY_PROFILE: "shared"

      - name: Run coverage for product contracts
        if: ${{ !contains(fromJson('["vrf"]'), env.PRODUCT) && !contains(fromJson('["automation"]'), env.PRODUCT) && !contains(fromJson('["functions"]'), env.PRODUCT) && needs.changes.outputs.product_changes == 'true' }}
        working-directory: contracts
        run: forge coverage --report lcov --report-file code-coverage/lcov-${{ env.PRODUCT }}.info
        env:
          FOUNDRY_PROFILE: ${{ env.PRODUCT }}

      - name: Run coverage for shared contracts
        if: ${{ needs.changes.outputs.shared_changes == 'true' }}
        working-directory: contracts
        run: forge coverage --report lcov --report-file code-coverage/lcov-shared.info
        env:
          FOUNDRY_PROFILE: "shared"

      - name: Generate Code Coverage HTML report for product contracts
        if: ${{ !contains(fromJson('["vrf"]'), env.PRODUCT) && !contains(fromJson('["automation"]'), env.PRODUCT) && !contains(fromJson('["functions"]'), env.PRODUCT) && needs.changes.outputs.product_changes == 'true' }}
        shell: bash
        run: cd contracts && genhtml code-coverage/lcov-${{ env.PRODUCT }}.info --branch-coverage --output-directory code-coverage/${{ env.PRODUCT }}

      - name: Generate Code Coverage HTML report for shared contracts
        if: ${{ needs.changes.outputs.shared_changes == 'true' }}
        shell: bash
        run: cd contracts && genhtml code-coverage/lcov-shared.info --branch-coverage --output-directory code-coverage/shared

      - name: Run Forge doc for product contracts
        if: ${{ needs.changes.outputs.product_changes == 'true' }}
        run: forge doc --build -o docs/${{ env.PRODUCT }}
        working-directory: contracts
        env:
          FOUNDRY_PROFILE: ${{ env.PRODUCT }}

      - name: Run Forge doc for shared contracts
        if: ${{ needs.changes.outputs.shared_changes == 'true' }}
        run: forge doc --build -o docs/shared
        working-directory: contracts
        env:
          FOUNDRY_PROFILE: "shared"

      - name: Upload Artifacts for product contracts
        if: ${{ needs.changes.outputs.product_changes == 'true' }}
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b # v4.3.4
        timeout-minutes: 2
        continue-on-error: true
        with:
          name: tmp-${{ env.PRODUCT }}-artifacts
          path: |
            contracts/docs/${{ env.PRODUCT }}
            contracts/code-coverage/lcov-${{ env.PRODUCT }}.info
            contracts/code-coverage/${{ env.PRODUCT }}
          retention-days: 7

      - name: Upload Artifacts for shared contracts
        if: ${{ needs.changes.outputs.shared_changes == 'true' }}
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b # v4.3.4
        timeout-minutes: 2
        continue-on-error: true
        with:
          name: tmp-shared-artifacts
          path: |
            contracts/docs/shared
            contracts/code-coverage/lcov-shared.info
            contracts/code-coverage/shared
          retention-days: 7

  # Generates UML diagrams and Slither reports for modified contracts
  uml-static-analysis:
    if: ${{ needs.changes.outputs.product_changes == 'true' || needs.changes.outputs.shared_changes == 'true' }}
    name: Generate UML and Slither reports for modified contracts
    runs-on: ubuntu-22.04
    needs: [changes]
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout the repo
        uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup NodeJS
        uses: ./.github/actions/setup-nodejs

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8f1998e9878d786675189ef566a2e4bf24869773 # v1.2.0
        with:
          version: ${{ env.FOUNDRY_VERSION }}

      - name: Install Sol2uml
        run: |
          npm link sol2uml --only=production

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install solc-select and solc
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install solc-select
          sudo ln -s /usr/local/bin/solc-select /usr/bin/solc-select
          solc-select install 0.8.19
          solc-select use 0.8.19

      - name: Install Slither
        run: |
          python -m pip install --upgrade pip
          pip install slither-analyzer

      - name: Generate UML
        shell: bash
        run: |
          contract_list="${{ needs.changes.outputs.files }}"
          
          # modify remappings so that solc can find dependencies
          ./contracts/scripts/ci/modify_remappings.sh contracts contracts/remappings.txt
          mv remappings_modified.txt remappings.txt
          
          ./contracts/scripts/ci/generate_uml.sh "./" "contracts/uml-diagrams" "$contract_list"

      - name: Generate Slither Markdown reports
        run: |
          contract_list="${{ needs.changes.outputs.files }}"
          
          echo "::debug::Processing contracts: $contract_list"
          ./contracts/scripts/ci/generate_slither_report.sh "${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/" contracts/.slither.config-artifacts.json "." "$contract_list" "contracts/slither-reports" "--solc-remaps @=contracts/node_modules/@"

      - name: Upload UMLs and Slither reports
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b # v4.3.4
        timeout-minutes: 10
        continue-on-error: true
        with:
          name: tmp-contracts-artifacts
          path: |
            contracts/uml-diagrams
            contracts/slither-reports
          retention-days: 7

      - name: Validate UMLs and Slither reports
        if: ${{ needs.changes.outputs.product_changes == 'true' || needs.changes.outputs.shared_changes == 'true' }}
        run: |
          echo "Validating UMLs and Slither reports"
          IFS=',' read -r -a modified_files <<< "${{ needs.changes.outputs.files }}"
          missing_svgs=()
          missing_reports=()
          for file in "${modified_files[@]}"; do      
            # TODO remove this check when AurorNZ/paths-filter is fixed
            status=$(git diff --name-status ${{ env.BASE_REF }} ${{ github.sha }} -- "$file"  | awk '{ print $1 }')
            if [ "$status" == "D" ]; then
              echo "File $file was deleted, skipping validation"
              continue
            fi
          
            svg_file="$(basename "${file%.sol}").svg"
            if [ ! -f "contracts/uml-diagrams/$svg_file" ]; then
              echo "Error: UML diagram for $file not found"
              missing_svgs+=("$file")
            fi
          
            report_file="$(basename "${file%.sol}")-slither-report.md"            
            if [ ! -f "contracts/slither-reports/$report_file" ]; then
              echo "Error: Slither report for $file not found"
              missing_reports+=("$file")
            fi
          done
          
          if [ ${#missing_svgs[@]} -gt 0 ]; then
              echo "Error: Missing UML diagrams for files: ${missing_svgs[@]}"
              echo "# Warning!" >> $GITHUB_STEP_SUMMARY
              echo "## Reason: Missing UML diagrams for files:" >> $GITHUB_STEP_SUMMARY
              for file in "${missing_svgs[@]}"; do
                echo " $file" >> $GITHUB_STEP_SUMMARY
              done
              echo "## Action required: Please try to generate artifacts for them locally or using a different tool" >> $GITHUB_STEP_SUMMARY
          else 
              echo "All UML diagrams generated successfully"
          fi
          
          if [ ${#missing_reports[@]} -gt 0 ]; then
              echo "Error: Missing Slither reports for files: ${missing_reports[@]}"
              echo "# Warning!" >> $GITHUB_STEP_SUMMARY
              echo "## Reason: Missing Slither reports for files:" >> $GITHUB_STEP_SUMMARY
              for file in "${missing_reports[@]}"; do
                echo " $file" >> $GITHUB_STEP_SUMMARY
              done
              echo "## Action required: Please try to generate artifacts for them locally" >> $GITHUB_STEP_SUMMARY
          else 
             echo "All Slither reports generated successfully"
          fi

  gather-all-artifacts:
    name: Gather all artifacts
    if: ${{ needs.changes.outputs.product_changes == 'true' || needs.changes.outputs.shared_changes == 'true' }}
    runs-on: ubuntu-latest
    needs: [coverage-and-book, uml-static-analysis, gather-basic-info, changes]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@65a9edc5881444af0b9093a5e628f2fe47ea3b2e # v4.1.7
        with:
          path: review_artifacts
          merge-multiple: true

      - name: Upload all artifacts as single package
        uses: actions/upload-artifact@0b2256b8c012f0828dc542b3febcab082c67f72b # v4.3.4
        with:
          name: review-artifacts-${{ env.PRODUCT }}-${{ github.sha }}
          path: review_artifacts

      - name: Remove temporary artifacts
        uses: geekyeggo/delete-artifact@24928e75e6e6590170563b8ddae9fac674508aa1 # v5.0
        with:
          name: tmp-*

      - name: Print Artifact URL in job summary
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ARTIFACTS=$(gh api -X GET repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
          ARTIFACT_ID=$(echo "$ARTIFACTS" | jq '.artifacts[] | select(.name=="review-artifacts-${{ env.PRODUCT }}-${{ github.sha }}") | .id')
          echo "Artifact ID: $ARTIFACT_ID"
          
          echo "# Solidity Review Artifact Generated" >> $GITHUB_STEP_SUMMARY
          # TODO change to inputs.base_ref after testing
          echo "Base Ref used: **${{ env.BASE_REF }}**" >> $GITHUB_STEP_SUMMARY
          echo "Commit SHA used: **${{ github.sha }}**" >> $GITHUB_STEP_SUMMARY
          echo "[Artifact URL](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/$ARTIFACT_ID)" >> $GITHUB_STEP_SUMMARY        

  notify-no-changes:
    if: ${{ needs.changes.outputs.product_changes == 'false' && needs.changes.outputs.shared_changes == 'false' }}
    needs: [changes]
    runs-on: ubuntu-latest
    steps:
      - name: Print warning in job summary
        shell: bash
        run: |
          echo "# Solidity Review Artifact NOT Generated" >> $GITHUB_STEP_SUMMARY
          #TODO change to inputs.base_ref after testing
          echo "Base Ref used: **${{ env.BASE_REF }}**" >> $GITHUB_STEP_SUMMARY
          echo "Commit SHA used: **${{ github.sha }}**" >> $GITHUB_STEP_SUMMARY
          echo "## Reason: No modified Solidity files found for ${{ env.PRODUCT }}" >> $GITHUB_STEP_SUMMARY
          #TODO change to inputs.base_ref after testing
          echo "No modified Solidity files found between ${{ env.BASE_REF }} and ${{ github.sha }} commits or they are located outside of ./contracts/src/v0.8 folder" >> $GITHUB_STEP_SUMMARY
          exit 1
