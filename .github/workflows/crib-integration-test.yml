name: CRIB Integration Tests
on:
  push:
  workflow_call:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  test:
    runs-on: ubuntu-latest
    environment: integration
    permissions:
      id-token: write
      contents: read
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2

      - uses: cachix/install-nix-action@v18
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: setup-gap crib
        # TODO: update after testing and latest changes are released.
        uses: smartcontractkit/.github/actions/setup-gap@crib-274/multi-gap-and-tls # setup-gap@0.4.0
        with:
          aws-role-arn: ${{ secrets.AWS_OIDC_CRIB_ROLE_ARN_STAGE }}
          api-gateway-host: ${{ secrets.AWS_API_GW_HOST_CRIB_STAGE }}
          aws-region: ${{ secrets.AWS_REGION }}
          ecr-private-registry: ${{ secrets.AWS_ACCOUNT_ID_PROD }}
          k8s-cluster-name: ${{ secrets.AWS_K8S_CLUSTER_NAME_STAGE }}
          gap-name: crib
          use-private-ecr-registry: true
          use-tls: true
          proxy-port: 8080
          metrics-job-name: "test"
          gc-basic-auth: ${{ secrets.GRAFANA_INTERNAL_BASIC_AUTH }}
          gc-host: ${{ secrets.GRAFANA_INTERNAL_HOST }}
          gc-org-id: ${{ secrets.GRAFANA_INTERNAL_TENANT_ID }}

      - name: setup-gap k8s
        # TODO: update after testing and latest changes are released.
        uses: smartcontractkit/.github/actions/setup-gap@crib-274/multi-gap-and-tls # setup-gap@0.4.0
        with:
          aws-role-arn: ${{ secrets.AWS_OIDC_CRIB_ROLE_ARN_STAGE }}
          api-gateway-host: ${{ secrets.AWS_API_GW_HOST_K8S_STAGE }}
          aws-region: ${{ secrets.AWS_REGION }}
          ecr-private-registry: ${{ secrets.AWS_ACCOUNT_ID_PROD }}
          k8s-cluster-name: ${{ secrets.AWS_K8S_CLUSTER_NAME_STAGE }}
          gap-name: k8s
          use-private-ecr-registry: true
          use-k8s: true
          proxy-port: 8443
          metrics-job-name: "test"
          gc-basic-auth: ${{ secrets.GRAFANA_INTERNAL_BASIC_AUTH }}
          gc-host: ${{ secrets.GRAFANA_INTERNAL_HOST }}
          gc-org-id: ${{ secrets.GRAFANA_INTERNAL_TENANT_ID }}
      #      - uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2
      #        name: Checkout CRIB repository
      #        with:
      #          repository: 'smartcontractkit/crib'
      #          ref: 'main'
      #      - name: Generate Short UUID
      #        id: uuid
      #        run: echo "CRIB_NAMESPACE=$(uuidgen | cut -c1-5)" >> $GITHUB_ENV
      #      - name: Create a new CRIB environment
      #        run: |-
      #          devspace use namespace $CRIB_NAMESPACE
      #          devspace deploy --profile local-dev-simulated-core-ocr1
      - uses: actions/checkout@9bb56186c3b09b4f86b1c65136769dd318469633 # v4.1.2
      - name: Setup go
        uses: actions/setup-go@0c52d547c9bc32b1aa3301fd7a9cb496313a4491 # v5.0.0
        with:
          go-version-file: "go.mod"
      - name: Run CRIB integration test
        working-directory: integration-tests/crib
        env:
          K8S_STAGING_INGRESS_SUFFIX: ${{ secrets.K8S_STAGING_INGRESS_SUFFIX }}
          CRIB_NAMESPACE: crib-skudasov
          CRIB_NETWORK: geth
          CRIB_NODES: 5
          GAP_URL: ${{ secrets.GAP_URL }}
          SETH_LOG_LEVEL: debug
          RESTY_DEBUG: true
        run: |-
          go test -v -run TestCRIB
