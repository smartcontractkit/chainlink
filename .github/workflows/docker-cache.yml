name: Update cache image

on:
  schedule:
    # Run every Sunday at midnight
    - cron: '0 0 * * 0'

  repository_dispatch:
    types: build-docker-cache

jobs:
  update-cache:
    runs-on: ubuntu-latest

    steps:
      - name: Free disk space
        run: |
          sudo swapoff -a
          sudo rm -f /swapfile
          sudo apt clean
          df -h

      # ssh checkout needed for https://github.com/peter-evans/create-pull-request/blob/master/docs/concepts-guidelines.md#push-using-ssh-deploy-keys
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ssh-key: '${{ secrets.SSH_PRIVATE_KEY }}'

      - name: Update Cache File
        id: updateCacheFile
        uses: smartcontractkit/docker-cache@99a8aec1b4eb98e0627aefe07223c9d8bec5ba33
        with:
          actionType: 'UPDATE_CACHE_FILE'

      - name: Get current date
        id: getDate
        run: echo "::set-output name=date::$(date -u +"%Y-%m-%dT%H%MZ")"

      - name: Publish to Docker Hub
        uses: elgohr/Publish-Docker-Github-Action@2.14
        with:
          name: 'smartcontract/builder-cache'
          dockerfile: 'builder-cache.Dockerfile'
          tags: '${{ steps.updateCacheFile.outputs.builderVersion }}-${{ steps.getDate.outputs.date }}'
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws-secret-access-key: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          aws-region: "us-west-2"
          role-to-assume: "${{ secrets.AWS_ROLE_TO_ASSUME }}"
          role-external-id: "${{ secrets.AWS_ROLE_EXTERNAL_ID }}"
          role-duration-seconds: 1200
          role-session-name: "BuilderCacheBuildAndPush"

      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Push image to AWS ECR
        env:
          ECR_REGISTRY: "${{ steps.login-ecr.outputs.registry }}"
          ECR_REPOSITORY: "chainlink/builder-cache"
          IMAGE_TAG1: "${{ steps.updateCacheFile.outputs.builderVersion }}"
          IMAGE_TAG2: "${{ github.sha }}"
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG1
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG2

      - name: Update docker files
        uses: smartcontractkit/docker-cache@99a8aec1b4eb98e0627aefe07223c9d8bec5ba33
        with:
          actionType: 'UPDATE_DOCKER_FILES'

      - name: Open PR with updated cache and docker files
        uses: peter-evans/create-pull-request@v2.7.0
        with:
          title: 'Update docker cache image'
          commit-message: 'Update docker cache image'
