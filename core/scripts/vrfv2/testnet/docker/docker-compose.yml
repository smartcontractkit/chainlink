version: '3.5'
services:
  chainlink-node-0:
    container_name: vrf-primary-node
    image: public.ecr.aws/chainlink/chainlink:2.3.0
    entrypoint:
      - /opt/docker-wait-for-others.sh
      - database:5432
      - --
    command: chainlink node -config /opt/config/config.toml start -p /run/secrets/node_password -a /run/secrets/apicredentials
    environment:
      - CL_DATABASE_URL=postgresql://postgres:chainlink@database:5432/chainlink_0_test?sslmode=disable
    platform: "linux/x86_64"
    volumes:
      - ./wait-for-others/docker-wait-for-it.sh:/opt/docker-wait-for-it.sh:ro
      - ./wait-for-others/docker-wait-for-others.sh:/opt/docker-wait-for-others.sh:ro
      - ./toml-config:/opt/config:ro
    ports:
      - "6610:6688"
      - "6059:6060"
    secrets:
      - apicredentials
      - keystore
      - node_password
    depends_on:
      - database

  database:
    image: postgres:11.6
    volumes:
      - ./db/create-multiple-databases.sh:/docker-entrypoint-initdb.d/create-multiple-databases.sh
    environment:
      POSTGRES_PASSWORD: chainlink
      POSTGRES_MULTIPLE_DATABASES: chainlink_0_test
    ports:
      - "5432:5432"

secrets:
  node_password:
    file: ./secrets/password.txt
  apicredentials:
    file: ./secrets/apicredentials
  keystore:
    file: ./secrets/0xb90c7E3F7815F59EAD74e7543eB6D9E8538455D6.json

volumes:
  docker-compose-db:
