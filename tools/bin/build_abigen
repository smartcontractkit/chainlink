#!/bin/bash

# Checks that the correct abigen is installed in this directory, and installs it
# if not.

set -e

# Version of abigen to install. Must be run within chainlink project
if [[ $(go list -json -m github.com/ethereum/go-ethereum | jq -r .Replace) != "null" ]]; then
  GETH_VERSION=$(go list -json -m github.com/ethereum/go-ethereum | jq -r .Replace.Version | cut -d'-' -f3)
  GETH_REPO_URL=$(echo "https://"$(go list -json -m github.com/ethereum/go-ethereum | jq -r .Replace.Path))
else
  GETH_VERSION=$(go list -json -m github.com/ethereum/go-ethereum | jq -r .Version)
  GETH_REPO_URL="https://github.com/ethereum/go-ethereum"
fi
echo $GETH_REPO_URL $GETH_REPO_URL

function realpath { echo $(cd $(dirname $1); pwd)/$(basename $1); }
THIS_DIR="$(realpath "$(dirname $0)")"

NATIVE_ABIGEN_VERSION=v"$(
    "$THIS_DIR/abigen" --version 2> /dev/null | \
    grep -E -o '([0-9]+\.[0-9]+\.[0-9]+)'
)" || true

if [ "$NATIVE_ABIGEN_VERSION" == "$GETH_VERSION" ]; then
    echo "Correct abigen version already installed."
    exit 0
fi

function cleanup() {
    rm -rf "$TMPDIR"
}

trap cleanup EXIT

TMPDIR="$(mktemp -d)"

pushd "$TMPDIR"

git clone "$GETH_REPO_URL"
cd go-ethereum/cmd/abigen
git checkout $GETH_VERSION
go build
cp ./abigen "$THIS_DIR"

popd

